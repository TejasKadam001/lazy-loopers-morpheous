<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sero ‚Äî Symptom Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=DM+Serif+Display:ital@0;1&display=swap"
        rel="stylesheet" />
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #f9f9f8;
            --surface: #ffffff;
            --border: #e8e8e5;
            --border-h: #c8c8c4;
            --text: #111110;
            --mid: #7a7a78;
            --faint: #f2f2f0;
            --accent: #111110;
            --blue: #1d6adb;
            --blue-l: #ebf1fd;
            --r: 16px;
            --rs: 11px;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.55;
            -webkit-font-smoothing: antialiased;
        }

        /* SITE NAV ‚Äî matches the pill navbar on all other pages */
        .navbar12_component {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            padding-top: 1rem;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        .navbar12_container {
            background-color: #000;
            color: #fff;
            border-radius: 9999px;
            padding: 0.5rem 2rem;
            max-width: max-content;
            margin: 0 auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06);
            border: 1px solid rgba(255, 255, 255, .1);
            display: flex;
            align-items: center;
            gap: 2rem;
            justify-content: space-between;
        }

        .navbar12_logo-link {
            text-decoration: none;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .navbar12_menu {
            background: transparent;
            display: flex;
            align-items: center;
            gap: .25rem;
        }

        .navbar12_menu-links {
            display: flex;
            align-items: center;
            gap: .25rem;
        }

        .navbar12_link {
            text-decoration: none !important;
            padding: 0.625rem 1rem;
            display: inline-block;
        }

        .navbar12_link-label {
            color: #fff;
            font-family: sans-serif;
            font-size: 1rem;
            font-weight: 400;
            transition: all .2s ease;
            text-decoration: none !important;
            white-space: nowrap;
        }

        .navbar12_link:hover .navbar12_link-label {
            text-shadow: 0 0 .5px #fff, 0 0 .5px #fff;
        }

        .navbar12_link-label.active {
            font-weight: 500;
            text-decoration: underline;
        }

        .navbar12_menu-buttons {
            margin-left: 1rem;
        }

        .nav-cta {
            background: #fff;
            color: #000;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            text-decoration: none;
            font-family: sans-serif;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            text-transform: none !important;
        }

        /* Mobile menu background fix */
        @media screen and (max-width: 991px) {
            .navbar12_menu {
                background-color: #000 !important;
                border-radius: 20px;
                padding: 1.5rem;
                margin-top: 1rem;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                flex-direction: column;
                align-items: stretch;
            }

            .navbar12_menu-links {
                flex-direction: column;
                gap: 1rem !important;
                padding-bottom: 1rem;
            }

            .navbar12_menu-buttons {
                margin-left: 0 !important;
                width: 100%;
            }

            .navbar12_menu-buttons .nav-cta {
                width: 100%;
                text-align: center;
                display: block;
            }
        }

        /* LAYOUT */
        .app {
            display: flex;
            height: 100vh;
            padding-top: 72px;
        }

        /* 3D PANEL */
        .body-panel {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--bg);
            border-right: 1px solid var(--border);
        }

        #three-canvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #three-canvas:active {
            cursor: grabbing;
        }

        /* Controls overlay */
        .controls-overlay {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            flex-direction: column;
            gap: .55rem;
            z-index: 10;
        }

        .ctrl-card {
            background: rgba(255, 255, 255, .88);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: var(--rs);
            padding: .65rem .85rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, .06);
        }

        .ctrl-label {
            font-size: 9.5px;
            font-weight: 600;
            letter-spacing: .12em;
            text-transform: uppercase;
            color: var(--mid);
            margin-bottom: .45rem;
        }

        .ctrl-btns {
            display: flex;
            gap: .35rem;
        }

        .ctrl-btn {
            padding: .35rem .75rem;
            border-radius: 99px;
            border: 1px solid var(--border);
            background: var(--surface);
            font-size: 12px;
            font-family: inherit;
            color: var(--mid);
            cursor: pointer;
            transition: all .15s;
        }

        .ctrl-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .ctrl-btn:hover:not(.active) {
            border-color: var(--border-h);
            color: var(--text);
        }

        /* Loading / hint */
        .body-hint {
            position: absolute;
            bottom: 1.25rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--mid);
            white-space: nowrap;
            pointer-events: none;
        }

        #loading-msg {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: .75rem;
            color: var(--mid);
            font-size: 13px;
            background: var(--bg);
            z-index: 20;
        }

        .load-dots {
            display: flex;
            gap: 5px;
        }

        .load-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--blue);
            animation: bdot 1.1s infinite;
        }

        .load-dot:nth-child(2) {
            animation-delay: .18s;
        }

        .load-dot:nth-child(3) {
            animation-delay: .36s;
        }

        @keyframes bdot {

            0%,
            80%,
            100% {
                transform: translateY(0);
                opacity: .4
            }

            40% {
                transform: translateY(-5px);
                opacity: 1
            }
        }

        /* SIDE PANEL */
        .side-panel {
            width: 330px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            overflow: hidden;
        }

        .side-header {
            padding: 1.15rem 1.2rem .9rem;
            border-bottom: 1px solid var(--border);
        }

        .side-header h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.3rem;
            letter-spacing: -.02em;
            color: var(--text);
            margin-bottom: 2px;
        }

        .side-header p {
            font-size: 12px;
            color: var(--mid);
        }

        .side-body {
            flex: 1;
            overflow-y: auto;
            padding: .9rem 1.2rem;
        }

        .side-body::-webkit-scrollbar {
            width: 4px;
        }

        .side-body::-webkit-scrollbar-thumb {
            background: var(--border-h);
            border-radius: 4px;
        }

        /* Empty */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--mid);
            text-align: center;
            gap: .4rem;
            padding: 2rem;
        }

        .empty-state svg {
            opacity: .16;
            margin-bottom: .3rem;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* Part cards */
        .part-card {
            border: 1px solid var(--border);
            border-radius: var(--rs);
            margin-bottom: .65rem;
            overflow: hidden;
            animation: sIn .14s ease;
        }

        @keyframes sIn {
            from {
                opacity: 0;
                transform: translateY(4px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .part-card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .6rem .8rem;
            background: var(--faint);
        }

        .part-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }

        .part-actions {
            display: flex;
            align-items: center;
            gap: .35rem;
        }

        .part-badge {
            font-size: 10.5px;
            background: var(--blue-l);
            color: var(--blue);
            border-radius: 99px;
            padding: 1px 7px;
        }

        .card-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--mid);
            padding: 2px;
            transition: color .15s;
            font-family: inherit;
        }

        .card-btn:hover {
            color: var(--text);
        }

        .card-btn.edit {
            text-decoration: underline;
        }

        .part-syms {
            padding: .45rem .8rem .55rem;
            display: flex;
            flex-wrap: wrap;
            gap: .25rem;
        }

        .sym-pill {
            font-size: 11px;
            color: var(--text);
            background: var(--blue-l);
            border-radius: 99px;
            padding: 2px 8px;
        }

        /* Footer */
        .side-footer {
            padding: .9rem 1.2rem;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: .5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 99px;
            padding: .6rem 1.2rem;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity .2s;
            width: 100%;
        }

        .btn-primary:hover {
            opacity: .82;
        }

        .btn-primary:disabled {
            opacity: .35;
            cursor: default;
        }

        .btn-ghost {
            background: transparent;
            color: var(--mid);
            border: 1px solid var(--border);
            border-radius: 99px;
            padding: .5rem 1.2rem;
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
            transition: border-color .15s, color .15s;
            width: 100%;
        }

        .btn-ghost:hover {
            border-color: var(--border-h);
            color: var(--text);
        }

        /* MODALS */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(17, 17, 16, .42);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-bg.open {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: var(--r);
            width: 100%;
            max-width: 440px;
            max-height: 88vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 60px rgba(0, 0, 0, .13);
            animation: mIn .17s ease;
        }

        @keyframes mIn {
            from {
                opacity: 0;
                transform: scale(.96)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.1rem .85rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-head h3 {
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
        }

        .modal-head p {
            font-size: 12px;
            color: var(--mid);
            margin-top: 1px;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: var(--faint);
            border-radius: 50%;
            cursor: pointer;
            font-size: 17px;
            color: var(--mid);
            line-height: 1;
            transition: background .15s;
        }

        .modal-close:hover {
            background: var(--border);
            color: var(--text);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: .5rem;
        }

        .modal-body::-webkit-scrollbar {
            width: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .modal-foot {
            padding: .8rem 1.1rem;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: .5rem;
        }

        .modal-cancel {
            font-size: 13px;
            color: var(--mid);
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
            padding: .4rem .6rem;
            transition: color .15s;
        }

        .modal-cancel:hover {
            color: var(--text);
        }

        .modal-save {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 99px;
            padding: .5rem 1.2rem;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity .2s;
        }

        .modal-save:hover {
            opacity: .82;
        }

        /* Region list */
        .region-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: .75rem 1rem;
            border-radius: var(--rs);
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 13.5px;
            color: var(--text);
            transition: background .12s;
            text-align: left;
        }

        .region-btn:hover {
            background: var(--faint);
        }

        .region-arrow {
            color: var(--mid);
        }

        /* Symptom list */
        .sym-search {
            display: flex;
            align-items: center;
            gap: .55rem;
            padding: .6rem .8rem;
            margin: .45rem;
            background: var(--faint);
            border-radius: var(--rs);
        }

        .sym-search svg {
            flex-shrink: 0;
            stroke: var(--mid);
        }

        .sym-search input {
            background: transparent;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 13.5px;
            color: var(--text);
            flex: 1;
        }

        .sym-search input::placeholder {
            color: var(--mid);
        }

        .sym-item {
            display: flex;
            align-items: center;
            gap: .7rem;
            padding: .65rem 1rem;
            border-radius: var(--rs);
            cursor: pointer;
            transition: background .1s;
        }

        .sym-item:hover {
            background: var(--faint);
        }

        .sym-check {
            width: 17px;
            height: 17px;
            border-radius: 5px;
            border: 1.5px solid var(--border-h);
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: border-color .12s, background .12s;
        }

        .sym-item.sel .sym-check {
            background: var(--blue);
            border-color: var(--blue);
        }

        .sym-item.sel .sym-check::after {
            content: '‚úì';
            font-size: 9px;
            color: #fff;
            line-height: 1;
        }

        .sym-item.sel .sym-label {
            color: var(--blue);
            font-weight: 500;
        }

        .sym-label {
            font-size: 13px;
            color: var(--text);
        }

        .sym-custom {
            padding: .55rem .8rem;
            margin: .4rem;
            border-top: 1px solid var(--border);
        }

        .sym-custom label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: .1em;
            text-transform: uppercase;
            color: var(--mid);
            display: block;
            margin-bottom: .35rem;
        }

        .sym-custom textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: var(--rs);
            padding: .55rem .7rem;
            font-family: inherit;
            font-size: 13px;
            color: var(--text);
            resize: none;
            outline: none;
            background: var(--faint);
            transition: border-color .15s;
        }

        .sym-custom textarea:focus {
            border-color: var(--blue);
            background: #fff;
        }

        .sym-custom textarea::placeholder {
            color: var(--mid);
        }

        /* RX PANEL */
        #rx-panel {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 300;
            background: var(--bg);
            flex-direction: column;
        }

        #rx-panel.open {
            display: flex;
        }

        .rx-nav {
            height: 52px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.75rem;
            background: rgba(249, 249, 248, .9);
            backdrop-filter: blur(12px);
        }

        .rx-nav-title {
            font-size: 13px;
            color: var(--mid);
        }

        .rx-body {
            flex: 1;
            display: grid;
            grid-template-columns: 260px 1fr;
            overflow: hidden;
        }

        .rx-summary {
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 1.35rem 1.1rem;
        }

        .rx-summary h3 {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: .12em;
            text-transform: uppercase;
            color: var(--mid);
            margin-bottom: .8rem;
        }

        .rx-row {
            margin-bottom: 1rem;
        }

        .rx-part-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: .25rem;
        }

        .rx-pills {
            display: flex;
            flex-wrap: wrap;
            gap: .22rem;
        }

        .rx-pill {
            font-size: 11px;
            background: var(--blue-l);
            color: var(--blue);
            border-radius: 99px;
            padding: 2px 8px;
        }

        .rx-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 2.25rem;
        }

        .rx-content h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.55rem;
            letter-spacing: -.025em;
            color: var(--text);
            margin-bottom: 1.4rem;
        }

        .rx-loading {
            display: flex;
            align-items: center;
            gap: .65rem;
            color: var(--mid);
            font-size: 13px;
        }

        .rx-loading .dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--blue);
            animation: bdot 1.1s infinite;
        }

        .rx-loading .dot:nth-child(2) {
            animation-delay: .18s;
        }

        .rx-loading .dot:nth-child(3) {
            animation-delay: .36s;
        }

        .rx-section {
            margin-bottom: 1.75rem;
        }

        .rx-section-title {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: .12em;
            text-transform: uppercase;
            color: var(--mid);
            margin-bottom: .65rem;
        }

        .rx-card {
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: .9rem 1rem;
            margin-bottom: .5rem;
            background: var(--surface);
        }

        .rx-card-title {
            font-size: 13.5px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: .22rem;
        }

        .rx-card-desc {
            font-size: 12.5px;
            color: var(--mid);
            line-height: 1.55;
        }

        .rx-urgent {
            border-color: #fbdcd8;
            background: #fff8f7;
        }

        .rx-urgent .rx-card-title {
            color: #c0392b;
        }

        .rx-disclaimer {
            margin-top: 2rem;
            padding: .8rem .95rem;
            background: var(--faint);
            border: 1px solid var(--border);
            border-radius: var(--rs);
            font-size: 12px;
            color: var(--mid);
            line-height: 1.55;
        }

        /* toast */
        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(2rem);
            background: #111;
            color: #fff;
            border-radius: 99px;
            padding: .5rem 1.3rem;
            font-size: 13px;
            opacity: 0;
            transition: opacity .25s, transform .25s;
            pointer-events: none;
            z-index: 999;
        }

        #toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>

    <!-- Site Navbar -->
    <div class="navbar12_component">
        <div class="navbar12_container">
            <a href="index.html" class="navbar12_logo-link">
                <strong style="color: white; font-size: 1.25rem; line-height: 1; display: block;">Sero</strong>
            </a>
            <nav class="navbar12_menu" role="navigation">
                <div class="navbar12_menu-links">
                    <a class="navbar12_link" href="solutions.html">
                        <div class="navbar12_link-label">AI Consult</div>
                    </a>
                    <a class="navbar12_link" href="wellbeing.html">
                        <div class="navbar12_link-label">Knowledge Hub</div>
                    </a>
                    <a class="navbar12_link" href="about.html">
                        <div class="navbar12_link-label">About Us</div>
                    </a>
                    <a class="navbar12_link" href="symptom-checker.html">
                        <div class="navbar12_link-label active">Symptom Checker</div>
                    </a>
                </div>
                <div class="navbar12_menu-buttons">
                    <a class="nav-cta" href="signup.html">Sign Up</a>
                </div>
            </nav>
        </div>
    </div>

    <div id="toast"></div>

    <div class="app">
        <!-- 3D Body -->
        <div class="body-panel">
            <div id="loading-msg">
                <div class="load-dots">
                    <div class="load-dot"></div>
                    <div class="load-dot"></div>
                    <div class="load-dot"></div>
                </div>
                <span id="loading-text">Loading 3D model‚Ä¶</span>
            </div>

            <canvas id="three-canvas"></canvas>

            <!-- Controls -->
            <div class="controls-overlay">
                <div class="ctrl-card">
                    <div class="ctrl-label">Body type</div>
                    <div class="ctrl-btns">
                        <button class="ctrl-btn active" id="btn-female" onclick="switchGender('female')">Female</button>
                        <button class="ctrl-btn" id="btn-male" onclick="switchGender('male')">Male</button>
                    </div>
                </div>
                <div class="ctrl-card" style="font-size:11px;color:var(--mid);padding:.5rem .75rem;line-height:1.45">
                    üñ± Drag to rotate ¬∑ Scroll to zoom
                </div>
            </div>

            <p class="body-hint" id="body-hint" style="display:none">Click any body part to add symptoms</p>
        </div>

        <!-- Right panel -->
        <div class="side-panel">
            <div class="side-header">
                <h2>Your Symptoms</h2>
                <p>Select areas on the model and describe what you feel</p>
            </div>
            <div class="side-body" id="side-body">
                <div class="empty-state" id="empty-state">
                    <svg width="38" height="38" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                    <p>Click a body part on the 3D model to start.</p>
                </div>
            </div>
            <div class="side-footer">
                <button class="btn-primary" id="analyze-btn" disabled onclick="runAnalysis()">Get prescription
                    ‚Üí</button>
                <button class="btn-ghost" id="clear-btn" style="display:none" onclick="clearAll()">Clear all</button>
            </div>
        </div>
    </div>

    <!-- Region modal -->
    <div class="modal-bg" id="region-modal">
        <div class="modal">
            <div class="modal-head">
                <div>
                    <h3 id="rm-title">Select area</h3>
                    <p>Tap the specific area where you feel symptoms</p>
                </div>
                <button class="modal-close" onclick="closeRegionModal()">√ó</button>
            </div>
            <div class="modal-body" id="rm-list"></div>
        </div>
    </div>

    <!-- Symptom modal -->
    <div class="modal-bg" id="sym-modal">
        <div class="modal" style="max-width:480px">
            <div class="modal-head">
                <div>
                    <h3 id="sm-title">Symptoms</h3>
                    <p>Select all that apply</p>
                </div>
                <button class="modal-close" onclick="closeSymModal()">√ó</button>
            </div>
            <div class="modal-body" id="sm-body"></div>
            <div class="modal-foot">
                <button class="modal-cancel" onclick="closeSymModal()">Cancel</button>
                <button class="modal-save" onclick="saveSymptoms()">Save symptoms</button>
            </div>
        </div>
    </div>

    <!-- Prescription panel -->
    <div id="rx-panel">
        <div class="rx-nav">
            <a href="javascript:void(0)" onclick="closeRx()" class="nav-back">‚Üê Back</a>
            <span class="rx-nav-title">Symptom Analysis</span>
            <span></span>
        </div>
        <div class="rx-body">
            <div class="rx-summary" id="rx-summary"></div>
            <div class="rx-content" id="rx-content">
                <h2>Analysing your symptoms‚Ä¶</h2>
                <div class="rx-loading">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <span>Generating prescription</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ THREE.JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
  }
}
</script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        // ‚îÄ‚îÄ Scene ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const canvas = document.getElementById('three-canvas');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.1;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf9f9f8);

        const camera = new THREE.PerspectiveCamera(42, 1, 0.1, 100);
        camera.position.set(0, 1, 6);

        // Lights
        const ambient = new THREE.AmbientLight(0xffffff, 1.2);
        scene.add(ambient);
        const key = new THREE.DirectionalLight(0xffffff, 2.5);
        key.position.set(3, 8, 5);
        key.castShadow = true;
        scene.add(key);
        const fill = new THREE.DirectionalLight(0xd0e8ff, 1.0);
        fill.position.set(-4, 2, -4);
        scene.add(fill);
        const rim = new THREE.DirectionalLight(0xffd0d0, 0.6);
        rim.position.set(0, -2, -6);
        scene.add(rim);

        // Floor shadow
        const floorGeo = new THREE.PlaneGeometry(10, 10);
        const floorMat = new THREE.ShadowMaterial({ opacity: 0.08 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -3.6;
        floor.receiveShadow = true;
        scene.add(floor);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enablePan = false;
        controls.minDistance = 2.5;
        controls.maxDistance = 12;
        controls.minPolarAngle = Math.PI / 5;
        controls.maxPolarAngle = Math.PI / 1.6;
        controls.target.set(0, 0.5, 0);
        controls.update();

        // Raycaster
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // ‚îÄ‚îÄ Model state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentModel = null;
        let hoveredMesh = null;
        let modelBounds = null; // { min, max, height, halfWidth } ‚Äî set after load
        const selectedBodyParts = new Set();
        const matCache = new Map();

        function getMeshes() {
            const meshes = [];
            if (currentModel) currentModel.traverse(c => { if (c.isMesh) meshes.push(c); });
            return meshes;
        }

        function getMaterial(mesh) {
            if (Array.isArray(mesh.material)) return mesh.material[0];
            return mesh.material;
        }

        function backupMaterials(model) {
            matCache.clear();
            model.traverse(c => {
                if (c.isMesh) {
                    const m = getMaterial(c);
                    if (m) matCache.set(c.uuid, m.clone());
                }
            });
        }

        function resetMeshMaterial(mesh) {
            const orig = matCache.get(mesh.uuid);
            if (!orig) return;
            const m = getMaterial(mesh);
            if (!m) return;
            m.color.copy(orig.color);
            m.emissive.copy(orig.emissive);
            m.emissiveIntensity = orig.emissiveIntensity;
            m.transparent = orig.transparent;
            m.opacity = orig.opacity;
            m.needsUpdate = true;
        }

        function highlightMesh(mesh, mode) { // mode: 'hover' | 'selected'
            const m = getMaterial(mesh);
            if (!m) return;
            if (mode === 'selected') {
                m.color.set(0x2d80e8);
                m.emissive.set(0x0a4fa8);
                m.emissiveIntensity = 0.25;
                m.transparent = true;
                m.opacity = 0.92;
            } else {
                m.color.set(0x9ec6f5);
                m.emissive.set(0x9ec6f5);
                m.emissiveIntensity = 0.12;
                m.transparent = false;
                m.opacity = 1;
            }
            m.needsUpdate = true;
        }

        function updateAllHighlights() {
            if (!currentModel) return;
            currentModel.traverse(c => {
                if (!c.isMesh) return;
                const friendly = meshToFriendly(c);
                if (friendly && selectedBodyParts.has(friendly)) {
                    highlightMesh(c, 'selected');
                } else if (c === hoveredMesh) {
                    highlightMesh(c, 'hover');
                } else {
                    resetMeshMaterial(c);
                }
            });
        }

        // ‚îÄ‚îÄ GLB Loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/libs/draco/');
        const loader = new GLTFLoader();
        loader.setDRACOLoader(dracoLoader);

        window._currentGender = 'female';

        function loadModel(gender) {
            const path = `3d-body-selector/${gender}.glb`;
            document.getElementById('loading-msg').style.display = 'flex';
            document.getElementById('loading-text').textContent = `Loading ${gender} model‚Ä¶`;
            document.getElementById('body-hint').style.display = 'none';

            // Remove old model
            if (currentModel) { scene.remove(currentModel); currentModel = null; }
            hoveredMesh = null;

            loader.load(path, gltf => {
                const model = gltf.scene;

                // Apply scale before computing bounds
                model.scale.setScalar(gender === 'male' ? 0.9 : 0.85);
                model.updateMatrixWorld(true);

                // Compute bounding box in world space
                const box = new THREE.Box3().setFromObject(model);
                const center = new THREE.Vector3();
                box.getCenter(center);

                // Center horizontally, keep vertical offset so feet near floor
                model.position.x -= center.x;
                model.position.z -= center.z;
                // Place feet at y = -2, head near top of view
                model.position.y -= box.min.y + 2;

                model.updateMatrixWorld(true);

                // Recompute bounds in world space after repositioning
                const worldBox = new THREE.Box3().setFromObject(model);
                modelBounds = {
                    min: worldBox.min.clone(),
                    max: worldBox.max.clone(),
                    height: worldBox.max.y - worldBox.min.y,
                    halfWidth: (worldBox.max.x - worldBox.min.x) * 0.5
                };

                // Fit camera to model
                const modelH = modelBounds.height;
                camera.position.set(0, worldBox.min.y + modelH * 0.5, modelH * 1.8);
                controls.target.set(0, worldBox.min.y + modelH * 0.5, 0);
                controls.update();

                // Move floor to feet level
                floor.position.y = worldBox.min.y - 0.01;

                model.traverse(c => { if (c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });
                backupMaterials(model);
                scene.add(model);
                currentModel = model;
                updateAllHighlights();

                document.getElementById('loading-msg').style.display = 'none';
                document.getElementById('body-hint').style.display = 'block';
            }, xhr => {
                const pct = Math.round(xhr.loaded / xhr.total * 100);
                document.getElementById('loading-text').textContent = `Loading ${gender} model‚Ä¶ ${pct}%`;
            }, err => {
                console.error('GLB load error:', err);
                document.getElementById('loading-text').textContent = 'Failed to load model. Is the server running at localhost:8000?';
            });
        }
        loadModel('female');

        window.switchGender = function (g) {
            window._currentGender = g;
            document.getElementById('btn-female').classList.toggle('active', g === 'female');
            document.getElementById('btn-male').classList.toggle('active', g === 'male');
            loadModel(g);
        };

        // ‚îÄ‚îÄ Coordinate-based body part mapping (from ModelLoader.jsx) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const BODY_MAP = {
            'Head': ['head', 'skull', 'face', 'jaw', 'nose', 'eye', 'ear', 'mouth', 'lip', 'teeth', 'tongue', 'hair'],
            'Neck': ['neck', 'cervical'],
            'Chest': ['chest', 'breast', 'pectoral', 'rib', 'thorax', 'sternum', 'upper_torso'],
            'Abdomen': ['abdomen', 'stomach', 'belly', 'waist', 'navel', 'pelvis', 'hip', 'lower_torso', 'torso', 'spine', 'back', 'lumbar'],
            'Shoulder': ['shoulder', 'deltoid', 'clavicle'],
            'Arm': ['arm', 'bicep', 'tricep', 'forearm', 'elbow', 'wrist'],
            'Hand': ['hand', 'finger', 'thumb', 'palm', 'knuckle'],
            'Leg': ['leg', 'thigh', 'calf', 'shin', 'knee', 'quadricep', 'hamstring', 'ankle'],
            'Foot': ['foot', 'toe', 'heel', 'sole']
        };

        // Generic mesh names that don't tell us the body part
        const GENERIC_NAMES = ['body', 'mesh', 'object', 'primitive', 'skin', 'character', 'human', 'figure', 'body__0', ''];

        function meshToFriendly(mesh) {
            const meshName = (mesh.name || '').toLowerCase();
            const isGeneric = GENERIC_NAMES.some(g => g === meshName || (g && meshName.includes(g)));
            if (isGeneric) return null; // fall back to coordinate mapping

            for (const [base, terms] of Object.entries(BODY_MAP)) {
                if (terms.some(t => meshName.includes(t))) return base;
            }
            return null; // unknown named mesh ‚Äî also fall back to coordinates
        }

        // Coordinate mapping using NORMALIZED position within the model's bounding box.
        // ny = 0 (feet) ‚Üí 1 (head), nx = relative horizontal position
        function coordinateFriendly(point) {
            if (!modelBounds) {
                // emergency fallback with rough absolutes
                const y = point.y;
                if (y > 1.2) return 'Head';
                if (y > 0.8) return 'Neck';
                if (y > 0) return 'Chest';
                if (y > -0.8) return 'Abdomen';
                if (y > -2.2) return 'Leg';
                return 'Foot';
            }

            const { min, height, halfWidth } = modelBounds;
            // ny: 0 = feet, 1 = top of head
            const ny = (point.y - min.y) / height;
            // nx: normalised horizontal ‚Äî 0 = centre, positive = model's left side (viewer's right)
            const nx = halfWidth > 0 ? point.x / halfWidth : 0;
            const isBack = point.z < (modelBounds.min.z + modelBounds.max.z) / 2;

            if (ny > 0.88) return 'Head';
            if (ny > 0.82) return 'Neck';
            if (ny > 0.60) {
                // Shoulder/arm zone
                if (Math.abs(nx) > 0.65) return 'Arm';
                return isBack ? 'Back' : 'Chest';
            }
            if (ny > 0.42) {
                if (Math.abs(nx) > 0.80) return 'Hand';
                if (Math.abs(nx) > 0.58) return 'Arm';
                return isBack ? 'Back' : 'Abdomen';
            }
            if (ny > 0.08) return 'Leg';
            return 'Foot';
        }

        function applyLaterality(base, meshName, point) {
            const limbs = ['Shoulder', 'Arm', 'Hand', 'Leg', 'Foot'];
            if (!limbs.includes(base)) return base.charAt(0).toUpperCase() + base.slice(1);

            let isLeft = false, isRight = false;
            if (meshName.includes('left') || meshName.endsWith('_l') || meshName.startsWith('l_')) isLeft = true;
            else if (meshName.includes('right') || meshName.endsWith('_r') || meshName.startsWith('r_')) isRight = true;
            // Use X coordinate ‚Äî positive X is model's left (facing us)
            else if (point.x > 0.05) isLeft = true;
            else if (point.x < -0.05) isRight = true;

            if (base === 'Shoulder') {
                if (isLeft) return 'Shoulder_L';
                if (isRight) return 'Shoulder_R';
                return 'Shoulder_L';
            }
            if (isLeft) return 'Left' + base.charAt(0).toUpperCase() + base.slice(1);
            if (isRight) return 'Right' + base.charAt(0).toUpperCase() + base.slice(1);
            return base.charAt(0).toUpperCase() + base.slice(1);
        }

        function getFriendlyName(mesh, point) {
            const meshName = (mesh.name || '').toLowerCase();
            let base = meshToFriendly(mesh);
            if (!base) base = coordinateFriendly(point);
            if (!base) base = 'Abdomen'; // absolute last resort
            return applyLaterality(base, meshName, point);
        }

        // ‚îÄ‚îÄ Mouse Events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getMouseNDC(event) {
            const rect = canvas.getBoundingClientRect();
            return new THREE.Vector2(
                ((event.clientX - rect.left) / rect.width) * 2 - 1,
                -((event.clientY - rect.top) / rect.height) * 2 + 1
            );
        }

        canvas.addEventListener('mousemove', e => {
            if (!currentModel) return;
            raycaster.setFromCamera(getMouseNDC(e), camera);
            const hits = raycaster.intersectObject(currentModel, true);
            const prev = hoveredMesh;
            hoveredMesh = hits.length ? hits[0].object : null;
            if (hoveredMesh !== prev) {
                canvas.style.cursor = hoveredMesh ? 'pointer' : 'grab';
                updateAllHighlights();
            }
        });

        canvas.addEventListener('click', e => {
            if (!currentModel) return;
            raycaster.setFromCamera(getMouseNDC(e), camera);
            const hits = raycaster.intersectObject(currentModel, true);
            if (!hits.length) return;
            const hit = hits[0];
            const friendly = getFriendlyName(hit.object, hit.point);
            // expose to global JS
            window._onPartClick(friendly);
        });

        // ‚îÄ‚îÄ Resize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function resize() {
            const parent = canvas.parentElement;
            const w = parent.clientWidth, h = parent.clientHeight;
            renderer.setSize(w, h);
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
        }
        window.addEventListener('resize', resize);
        resize();

        // ‚îÄ‚îÄ Render loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // expose updateAllHighlights to global
        window._updateHighlights = function (parts) {
            selectedBodyParts.clear();
            parts.forEach(p => selectedBodyParts.add(p));
            updateAllHighlights();
        };
    </script>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ APP LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <script>
        const REGIONS = {
            'Head': ['Head (General)', 'Face', 'Scalp', 'Forehead', 'Eyes', 'Ears', 'Nose', 'Mouth / Jaw', 'Back of Head'],
            'Neck': ['Neck (General)', 'Front of Neck (Throat)', 'Back of Neck'],
            'Chest': ['Chest (General)', 'Upper Chest', 'Lower Chest (Ribs)', 'Heart area'],
            'Abdomen': ['Abdomen (General)', 'Upper Abdomen', 'Lower Abdomen', 'Flank / Side'],
            'Back': ['Upper Back', 'Middle Back', 'Lower Back (Lumbar)', 'Tailbone'],
            'Pelvis': ['Pelvis (General)', 'Groin', 'Hips'],
            'Shoulder_L': ['Left Shoulder (General)', 'Front Shoulder', 'Back Shoulder', 'Shoulder Joint'],
            'Shoulder_R': ['Right Shoulder (General)', 'Front Shoulder', 'Back Shoulder', 'Shoulder Joint'],
            'LeftArm': ['Left Arm (General)', 'Upper Arm (Bicep / Tricep)', 'Elbow', 'Forearm', 'Wrist'],
            'RightArm': ['Right Arm (General)', 'Upper Arm (Bicep / Tricep)', 'Elbow', 'Forearm', 'Wrist'],
            'LeftHand': ['Hand (General)', 'Palm', 'Back of Hand', 'Fingers', 'Thumb'],
            'RightHand': ['Hand (General)', 'Palm', 'Back of Hand', 'Fingers', 'Thumb'],
            'LeftLeg': ['Left Leg (General)', 'Thigh', 'Hamstring', 'Knee', 'Shin', 'Calf', 'Ankle'],
            'RightLeg': ['Right Leg (General)', 'Thigh', 'Hamstring', 'Knee', 'Shin', 'Calf', 'Ankle'],
            'LeftFoot': ['Foot (General)', 'Heel', 'Sole', 'Top of Foot', 'Toes'],
            'RightFoot': ['Foot (General)', 'Heel', 'Sole', 'Top of Foot', 'Toes']
        };

        const SYMPTOMS = {
            'Forearm': ['Forearm feels more sensitive', 'Forearm feels weak', 'Forearm hurts', 'Forearm itches', 'Lump on forearm', 'Tingling or prickling', 'Swelling'],
            'Upper Arm (Bicep / Tricep)': ['Bicep shaking', 'Upper arm pain', 'Weakness', 'Muscle spasm', 'Swelling'],
            'Elbow': ['Joint pain', 'Stiffness', 'Difficulty bending', 'Tennis elbow', 'Swelling'],
            'Wrist': ['Carpal tunnel pain', 'Stiffness', 'Clicking sound', 'Swelling', 'Numbness'],
            'Thigh': ['Burning feeling', 'Cramp in thigh', 'Numbness', 'Pain in thigh', 'Sciatica pain'],
            'Hamstring': ['Pulling pain', 'Stiffness', 'Muscle tightness', 'Cramp'],
            'Knee': ['Knee pain', 'Swelling', 'Stiffness', 'Popping or clicking', 'Instability'],
            'Calf': ['Calf cramp', 'Muscle tightness', 'Swelling', 'DVT pain'],
            'Ankle': ['Ankle pain', 'Swelling', 'Stiffness', 'Tenderness'],
            'Face': ['Facial pain', 'Jaw ache', 'Sinus pressure', 'Numbness', 'Twitching'],
            'Eyes': ['Blurred vision', 'Eye pain', 'Redness', 'Discharge', 'Light sensitivity'],
            'Ears': ['Earache', 'Ringing (tinnitus)', 'Muffled hearing', 'Fullness in ear'],
            'Nose': ['Blocked nose', 'Runny nose', 'Loss of smell', 'Nosebleed'],
            'Upper Chest': ['Chest pain', 'Shortness of breath', 'Palpitations', 'Tightness', 'Heartburn'],
            'Heart area': ['Chest pressure', 'Radiating arm pain', 'Palpitations', 'Rapid heartbeat'],
            'Lower Chest (Ribs)': ['Rib pain', 'Pain when breathing', 'Tenderness on touch'],
            'Upper Abdomen': ['Nausea', 'Upper abdominal pain', 'Bloating', 'Acid reflux'],
            'Lower Abdomen': ['Cramping', 'Lower abdominal pain', 'Constipation', 'Diarrhea'],
            'Lower Back (Lumbar)': ['Lower back pain', 'Shooting pain down leg', 'Stiffness', 'Muscle spasm'],
            'Upper Back': ['Upper back pain', 'Stiffness', 'Shoulder blade pain'],
            'Head (General)': ['Headache', 'Dizziness', 'Migraine', 'Pressure in head'],
            'Neck (General)': ['Stiff neck', 'Neck pain', 'Swollen glands', 'Limited mobility'],
            'Heel': ['Heel pain', 'Plantar fasciitis pain', 'Tenderness'],
            'Toes': ['Toe pain', 'Numbness', 'Swelling', 'Gout pain'],
            'Default': ['Pain', 'Swelling', 'Redness', 'Numbness', 'Itching', 'Bruising', 'Rash', 'Stiffness', 'Weakness']
        };

        let selectedParts = [];
        let symptomsMap = {};
        let activeSubPart = null;
        let localSelected = [];
        let customText = '';

        const $ = id => document.getElementById(id);
        const toast = msg => { const t = $('toast'); t.textContent = msg; t.classList.add('show'); clearTimeout(t._t); t._t = setTimeout(() => t.classList.remove('show'), 2400); };

        // Expose click handler to Three.js module
        window._onPartClick = function (friendly) {
            openRegionModal(friendly);
        };

        // REGION MODAL
        function openRegionModal(partName) {
            const display = partName.replace('_', ' ').replace(/([A-Z])/g, ' $1').trim();
            $('rm-title').textContent = display;
            const list = $('rm-list');
            list.innerHTML = '';
            const subs = REGIONS[partName] || REGIONS[partName.replace('Left', '').replace('Right', '')] || [display];
            subs.forEach(sub => {
                const btn = document.createElement('button');
                btn.className = 'region-btn';
                btn.innerHTML = `<span>${sub}</span><span class="region-arrow">‚Ä∫</span>`;
                btn.onclick = () => { closeRegionModal(); openSymModal(sub); };
                list.appendChild(btn);
            });
            $('region-modal').classList.add('open');
        }
        function closeRegionModal() { $('region-modal').classList.remove('open'); }

        // SYMPTOM MODAL
        function openSymModal(subPart) {
            activeSubPart = subPart;
            localSelected = [...(symptomsMap[subPart] || []).filter(s => !s.startsWith('Custom: '))];
            const existing = (symptomsMap[subPart] || []).find(s => s.startsWith('Custom: '));
            customText = existing ? existing.replace('Custom: ', '') : '';
            $('sm-title').textContent = subPart + ' ¬∑ Symptoms';
            renderSymModal();
            $('sym-modal').classList.add('open');
        }

        function renderSymModal() {
            const availableRaw = SYMPTOMS[activeSubPart];
            let available;
            if (availableRaw) {
                available = availableRaw;
            } else {
                const friendly = activeSubPart.replace(' (General)', '').toLowerCase();
                available = SYMPTOMS['Default'].map(s => {
                    if (s === 'Pain') return `Pain in ${friendly}`;
                    if (s === 'Swelling') return `Swelling on ${friendly}`;
                    if (s === 'Numbness') return `Numbness in ${friendly}`;
                    if (s === 'Redness') return `${activeSubPart} looks red`;
                    return s;
                });
            }
            let html = `<div class="sym-search">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input type="text" placeholder="Search symptoms‚Ä¶" oninput="filterSymptoms(this.value)" />
  </div><div id="sym-list">`;
            available.forEach(sym => {
                const sel = localSelected.includes(sym);
                html += `<div class="sym-item${sel ? ' sel' : ''}" onclick="toggleSym(this,'${sym.replace(/'/g, "\\'")}')">
      <div class="sym-check"></div><span class="sym-label">${sym}</span></div>`;
            });
            html += `</div><div class="sym-custom">
    <label>Or describe your symptom</label>
    <textarea id="sym-ta" rows="2" placeholder="e.g. sharp throbbing pain that worsens at night‚Ä¶">${customText}</textarea>
  </div>`;
            $('sm-body').innerHTML = html;
        }

        window.filterSymptoms = q => {
            document.querySelectorAll('#sym-list .sym-item').forEach(el => {
                el.style.display = el.querySelector('.sym-label').textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        };
        window.toggleSym = (el, sym) => {
            const idx = localSelected.indexOf(sym);
            if (idx > -1) { localSelected.splice(idx, 1); el.classList.remove('sel'); }
            else { localSelected.push(sym); el.classList.add('sel'); }
        };
        window.closeSymModal = () => { $('sym-modal').classList.remove('open'); activeSubPart = null; };
        window.saveSymptoms = () => {
            const custom = $('sym-ta')?.value.trim() || '';
            const finals = [...localSelected];
            if (custom) finals.push('Custom: ' + custom);
            if (!selectedParts.includes(activeSubPart)) selectedParts.push(activeSubPart);
            symptomsMap[activeSubPart] = finals;
            closeSymModal();
            renderSidePanel();
            if (window._updateHighlights) window._updateHighlights(selectedParts);
        };

        // SIDE PANEL
        function renderSidePanel() {
            const hasParts = selectedParts.length > 0;
            $('empty-state').style.display = hasParts ? 'none' : '';
            $('analyze-btn').disabled = !hasParts;
            $('clear-btn').style.display = hasParts ? '' : 'none';
            document.querySelectorAll('.part-card').forEach(c => c.remove());
            selectedParts.forEach(part => {
                const syms = symptomsMap[part] || [];
                const card = document.createElement('div');
                card.className = 'part-card';
                card.innerHTML = `<div class="part-card-head">
      <span class="part-name">${part}</span>
      <div class="part-actions">
        <span class="part-badge">${syms.length} symptom${syms.length !== 1 ? 's' : ''}</span>
        <button class="card-btn edit" onclick="editPart('${part.replace(/'/g, "\\'")}')" >Edit</button>
        <button class="card-btn" onclick="removePart('${part.replace(/'/g, "\\'")}')">‚úï</button>
      </div>
    </div>
    <div class="part-syms">
      ${syms.map(s => `<span class="sym-pill">${s.replace('Custom: ', '‚úè ')}</span>`).join('')}
      ${!syms.length ? '<span style="font-size:11px;color:#bbb">No symptoms listed</span>' : ''}
    </div>`;
                $('side-body').insertBefore(card, $('side-body').firstChild);
            });
        }
        window.editPart = p => openSymModal(p);
        window.removePart = p => {
            selectedParts = selectedParts.filter(s => s !== p);
            delete symptomsMap[p];
            renderSidePanel();
            if (window._updateHighlights) window._updateHighlights(selectedParts);
        };
        window.clearAll = () => {
            selectedParts = []; symptomsMap = {};
            renderSidePanel();
            if (window._updateHighlights) window._updateHighlights([]);
        };
        window.closeRegionModal = () => $('region-modal').classList.remove('open');

        // PRESCRIPTION
        window.runAnalysis = () => {
            if (!selectedParts.length) { toast('Add at least one symptom first.'); return; }
            $('rx-panel').classList.add('open');
            renderRxSummary();
            setTimeout(generatePrescription, 1300);
        };
        window.closeRx = () => $('rx-panel').classList.remove('open');

        function renderRxSummary() {
            let html = '<h3>Reported Symptoms</h3>';
            selectedParts.forEach(p => {
                const syms = symptomsMap[p] || [];
                html += `<div class="rx-row"><div class="rx-part-name">${p}</div><div class="rx-pills">${syms.map(s => `<span class="rx-pill">${s.replace('Custom: ', '')}</span>`).join('') || '<span style="font-size:11px;color:#bbb">None listed</span>'}</div></div>`;
            });
            $('rx-summary').innerHTML = html;
            $('rx-content').innerHTML = `<h2>Analysing‚Ä¶</h2><div class="rx-loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div><span>Generating prescription</span></div>`;
        }

        function generatePrescription() {
            const allSyms = Object.values(symptomsMap).flat().map(s => s.toLowerCase().replace('custom: ', ''));
            const parts = selectedParts.map(p => p.toLowerCase());
            const urgent = [], likely = [], meds = [], advice = [];

            if (allSyms.some(s => s.includes('chest pressure') || s.includes('heart') || s.includes('radiating arm') || s.includes('palpitations')))
                urgent.push({ t: 'Possible Cardiac Event', d: 'Symptoms like chest pressure, arm pain, and palpitations can indicate angina or a heart attack. Seek emergency care immediately.' });
            if (allSyms.some(s => s.includes('blurred vision') || s.includes('migraine') || s.includes('numbness in face')))
                urgent.push({ t: 'Possible Neurological Concern', d: 'Sudden blurred vision, severe headache, or facial numbness may indicate a stroke or TIA. Call emergency services.' });

            if (parts.some(p => p.includes('knee') || p.includes('thigh') || p.includes('hamstring')))
                likely.push({ t: 'Musculoskeletal Strain / Overuse', d: 'Knee, thigh, or hamstring pain often stems from overuse, poor posture, or muscle imbalances. RICE protocol is first-line treatment.' });
            if (parts.some(p => p.includes('lower back') || p.includes('lumbar')))
                likely.push({ t: 'Lumbar Strain / Disc Irritation', d: 'Lower back pain with stiffness is commonly caused by postural issues, muscle strain, or disc compression.' });
            if (parts.some(p => p.includes('shoulder') || p.includes('elbow') || p.includes('wrist')))
                likely.push({ t: 'Repetitive Strain / Tendinitis', d: 'Shoulder, elbow, or wrist pain can indicate rotator cuff issues, tennis elbow, or carpal tunnel syndrome.' });
            if (allSyms.some(s => s.includes('shortness') || s.includes('tightness in chest')))
                likely.push({ t: 'Respiratory Involvement', d: 'Shortness of breath or chest tightness may indicate asthma, bronchitis, or anxiety-related chest tightening.' });
            if (parts.some(p => p.includes('abdomen')))
                likely.push({ t: 'Gastrointestinal Disturbance', d: 'Abdominal pain with nausea, bloating, or cramping commonly indicates IBS, gastritis, or acid reflux.' });
            if (parts.some(p => p.includes('head') || p.includes('face') || p.includes('eyes')))
                likely.push({ t: 'Tension Headache / Migraine', d: 'Pressure or pain in the head with facial or eye involvement is often tension-type headache or migraine.' });
            if (parts.some(p => p.includes('ankle') || p.includes('foot') || p.includes('heel')))
                likely.push({ t: 'Ankle / Foot Condition', d: 'Heel or foot pain is frequently due to plantar fasciitis, ankle sprain, or gout.' });
            if (!likely.length && !urgent.length)
                likely.push({ t: 'Localised Pain / Discomfort', d: 'The reported symptoms suggest localised irritation or minor injury. Monitor closely and consult a GP if symptoms persist beyond 3 days.' });

            if (allSyms.some(s => s.includes('swelling') || s.includes('tenderness')))
                advice.push({ t: 'RICE Protocol', d: 'Rest the area, apply Ice (15 min on/off), Compress with a bandage, and Elevate the limb above heart level.' });
            if (allSyms.some(s => s.includes('stiffness') || s.includes('tightness')))
                advice.push({ t: 'Gentle Stretching', d: 'Gentle, sustained stretches for 30 seconds per area, 2‚Äì3 times daily. Stop if it causes sharp pain.' });
            if (allSyms.some(s => s.includes('pain') || s.includes('cramp') || s.includes('ache'))) {
                advice.push({ t: 'Heat or Cold Therapy', d: 'Acute pain (<48 hrs) benefits from cold. Chronic or muscle pain responds better to heat. Apply for 15‚Äì20 minutes.' });
                meds.push({ t: 'OTC Pain Relief', d: 'Paracetamol (500‚Äì1000 mg, max 4√ó/day) or Ibuprofen (400 mg with food). Avoid Ibuprofen if you have stomach issues.' });
            }
            if (allSyms.some(s => s.includes('headache') || s.includes('migraine'))) {
                meds.push({ t: 'Headache Management', d: 'Rest in a dark, quiet room. Paracetamol or aspirin for mild headaches. For migraines, triptans (sumatriptan) are effective ‚Äî consult your GP.' });
                advice.push({ t: 'Hydration & Sleep', d: 'Dehydration is a common trigger. Drink 2‚Äì3L of water daily and maintain a consistent sleep schedule.' });
            }
            if (allSyms.some(s => s.includes('nausea') || s.includes('bloating')))
                meds.push({ t: 'Antacid / Digestive Aid', d: 'Antacids (e.g., Gaviscon) relieve heartburn. Simethicone helps with gas/bloating. Avoid spicy/fatty foods.' });
            advice.push({ t: 'When to Seek Medical Care', d: `Visit a GP if symptoms last more than 5‚Äì7 days, worsen significantly, are accompanied by fever >38¬∞C, or unexplained weight loss.` });

            let html = `<h2>Symptom Analysis</h2>`;
            if (urgent.length) {
                html += `<div class="rx-section"><div class="rx-section-title">‚ö† Urgent ‚Äî Seek care now</div>`;
                urgent.forEach(u => { html += `<div class="rx-card rx-urgent"><div class="rx-card-title">${u.t}</div><div class="rx-card-desc">${u.d}</div></div>`; });
                html += `</div>`;
            }
            html += `<div class="rx-section"><div class="rx-section-title">Likely conditions</div>`;
            likely.forEach(l => { html += `<div class="rx-card"><div class="rx-card-title">${l.t}</div><div class="rx-card-desc">${l.d}</div></div>`; });
            html += `</div>`;
            if (meds.length) {
                html += `<div class="rx-section"><div class="rx-section-title">Suggested medications</div>`;
                meds.forEach(m => { html += `<div class="rx-card"><div class="rx-card-title">${m.t}</div><div class="rx-card-desc">${m.d}</div></div>`; });
                html += `</div>`;
            }
            html += `<div class="rx-section"><div class="rx-section-title">Self-care advice</div>`;
            advice.forEach(a => { html += `<div class="rx-card"><div class="rx-card-title">${a.t}</div><div class="rx-card-desc">${a.d}</div></div>`; });
            html += `</div><div class="rx-disclaimer"><strong>Disclaimer:</strong> This analysis is generated by a rule-based system and is for informational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment. Always consult a qualified healthcare provider.</div>`;
            $('rx-content').innerHTML = html;
        }
    </script>
</body>

</html>